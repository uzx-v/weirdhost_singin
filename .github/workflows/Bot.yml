name: ä¸ƒå¤©ä¸€ç»­Bot

on:
  workflow_dispatch: # å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµï¼Œæ–¹ä¾¿æµ‹è¯•
  schedule:
    # ä½¿ç”¨ CRON è¡¨è¾¾å¼å®šä¹‰å®šæ—¶ä»»åŠ¡ï¼Œæ‰€æœ‰æ—¶é—´å‡ä¸º UTC æ—¶é—´ã€‚
    # '0 4 * * *' è¡¨ç¤ºåœ¨ UTC æ—¶é—´çš„æ¯å¤©å‡Œæ™¨4ç‚¹æ‰§è¡Œã€‚
    # å¦‚æžœæ‚¨ä½äºŽä¸œå…«åŒºï¼ˆå¦‚åŒ—äº¬æ—¶é—´ï¼‰ï¼Œè¿™å¯¹åº”æ‚¨æœ¬åœ°æ—¶é—´çš„æ¯å¤©ä¸­åˆ12ç‚¹ã€‚
    # å¦‚æžœæ‚¨åœ¨å…¶ä»–æ—¶åŒºï¼Œè¯·ç›¸åº”è°ƒæ•´ã€‚ä¾‹å¦‚ä¸œä¹åŒºï¼ˆä¸œäº¬/é¦–å°”æ—¶é—´ï¼‰ä¸­åˆ12ç‚¹æ˜¯UTCæ—¶é—´3ç‚¹ï¼Œåº”ä¸º '0 3 * * *'ã€‚
    - cron: '15 2 * * 0'

jobs:
  add_time:
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu çŽ¯å¢ƒä¸Šè¿è¡Œ

    # ã€ã€ã€ æ ¸å¿ƒä¿®æ”¹ç‚¹åœ¨è¿™é‡Œ ã€‘ã€‘ã€‘
    # æŽˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      contents: write

    steps:
      - name: Checkout repository # æ­¥éª¤1: æ£€å‡ºï¼ˆä¸‹è½½ï¼‰ä½ çš„ä»£ç åˆ°è¿è¡ŒçŽ¯å¢ƒä¸­
        uses: actions/checkout@v4

      - name: Set up Python # æ­¥éª¤2: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # ä½¿ç”¨æœ€æ–°çš„ Python 3

      - name: Install Playwright and dependencies # æ­¥éª¤3: å®‰è£… Playwright åŠå…¶æµè§ˆå™¨ä¾èµ–
        run: |
          pip install playwright
          playwright install --with-deps chromium # å®‰è£… Chromium æµè§ˆå™¨åŠå…¶è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–

      - name: Run Time Adder Script # æ­¥éª¤4: è¿è¡Œä½ çš„ Python è„šæœ¬
        env:
          # ä»Ž GitHub Secrets è¯»å–çŽ¯å¢ƒå˜é‡ï¼Œè¿™äº›å€¼ç»ä¸ä¼šåœ¨æ—¥å¿—ä¸­æ˜Žæ–‡æ˜¾ç¤º
          # ä¼˜å…ˆä½¿ç”¨ Cookie ç™»å½•
          REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
          # å¦‚æžœ Cookie å¤±æ•ˆæˆ–æœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨ä¸‹é¢çš„é‚®ç®±å’Œå¯†ç 
          PTERODACTYL_EMAIL: ${{ secrets.PTERODACTYL_EMAIL }}
          PTERODACTYL_PASSWORD: ${{ secrets.PTERODACTYL_PASSWORD }}
        run: python Bot.py

      - name: Upload error artifacts # æ­¥éª¤5: å¦‚æžœè„šæœ¬è¿è¡Œå¤±è´¥ï¼Œä¸Šä¼ æˆªå›¾ç”¨äºŽè°ƒè¯•
        if: failure() # ä»…åœ¨ä¸Šä¸€æ­¥å¤±è´¥æ—¶è¿è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots # ä¸Šä¼ åŽçš„æ–‡ä»¶åŒ…åç§°
          path: "*.png" # ä¸Šä¼ æ‰€æœ‰ä»¥ .png ç»“å°¾çš„æ–‡ä»¶

      - name: Update README with timestamp
        run: |
          # ç”Ÿæˆå½“å‰æ—¶é—´
          UTC_TIME=$(date -u +'%Y-%m-%d %H:%M:%S')
          BJ_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          # åœ¨ README æœ«å°¾æ·»åŠ æˆ–æ›´æ–°æ—¶é—´æˆ³
          TIMESTAMP_SECTION="\n## ðŸ•’ Botæœ€åŽæ›´æ–°æ—¶é—´\n\n"
          TIMESTAMP_SECTION+="**UTC**: \`$UTC_TIME\`  \n"
          TIMESTAMP_SECTION+="**åŒ—äº¬æ—¶é—´**: \`$BJ_TIME\`  \n\n"
          TIMESTAMP_SECTION+="> âš¡ æ­¤æ—¶é—´æˆ³ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°\n"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ—¶é—´æˆ³éƒ¨åˆ†
          if grep -q "## ðŸ•’ Botæœ€åŽæ›´æ–°æ—¶é—´" README.md; then
            sed -i '/## ðŸ•’ æœ€åŽæ›´æ–°æ—¶é—´/,/^## \|^# /{//!d}' README.md
            sed -i '/## ðŸ•’ æœ€åŽæ›´æ–°æ—¶é—´/d' README.md
          fi
          
          echo -e "$TIMESTAMP_SECTION" >> README.md
          
      - name: Auto commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto deploy by Github Actions"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          file_pattern: README.md
